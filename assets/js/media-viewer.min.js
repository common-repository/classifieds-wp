jQuery(document).ready(function(e){var a,i,t=wp.media.model.settings.post.id;if(""!=classified_manager_viewer_i18n.post_id_field)var s=e("input[name="+classified_manager_viewer_i18n.post_id_field+"]").val();else var s=classified_manager_viewer_i18n.post_id;s=parseInt(s),e(".classified-manager-media-viewer-spinner").html(""),e(document).on("click",".upload_button",function(m){function n(){e.ajax({type:"POST",url:classified_manager_viewer_i18n.ajaxurl,data:{action:"classified_manager_delete_media_viewer_transients"},dataType:"json"}).done(function(e){})}function l(){if(e(".max-upload-size").remove(),e(".embed-link-settings .setting").remove(),e(".media-menu-item.classified_manager-mv-item, .media-frame-title h1").each(function(){var a=e(this).text().replace("CLASSIFIED_MANAGER-MV-ITEM","").trim();e(this).text(a)}),e(".classified_manager-media-settings").remove(),h>0){var a=new Array("KB","MB","GB"),i=h;for(u=-1;i>=1024&&u<a.length-1;u++)i/=1024;u<0?(i=0,u=0):i=parseInt(i),e(".post-upload-ui").append('<p class="classified_manager-media-settings classified_manager-mv-file-size-restrictions classified_manager-mv-file-size">'+classified_manager_viewer_i18n.file_size_text+": "+i+a[u]+"</p>")}e(".embed-link-settings").append('<div class="classified_manager-media-settings classified_manager-mv-embed-settings" style="margin-top: 20px;"><label class="clear-embeds" style="margin-top: 10px;"><input class="clear-embeds" type="checkbox"> '+classified_manager_viewer_i18n.clear_embeds_text+"</input></label></div>"),w>0&&e(".classified_manager-mv-embed-settings").append('<p class="classified_manager-mv-embed-restrictions classified_manager-mv-embed-limit">'+classified_manager_viewer_i18n.embed_limit_text+": "+w+"</p>"),b>0&&e(".post-upload-ui").append('<p class="classified_manager-media-settings classified_manager-mv-file-restrictions classified_manager-mv-file-limit">'+classified_manager_viewer_i18n.files_limit_text+": "+b+"</p>"),v&&e(".post-upload-ui").append('<p class="classified_manager-media-settings classified_manager-mv-file-restrictions classified_manager-mv-file-types">'+classified_manager_viewer_i18n.files_type_text+": "+v+"</p>")}function d(){e(".media-embeds",c).html(""),e("input[name="+_+"]").val(""),e("input[name="+o+"]").val("")}m.preventDefault();var r=e(this).data("group-id"),_=r+"_embeds",o=r+"_attach_embeds",c=e("#"+r+" .media-placeholder"),p=e("#classified_manager_mv_nonce_"+r).val();if(void 0!==e("input[name="+r+"]").html()){var f="",v="",g="",h="",b=3,w=0,y="";if(classified_manager_viewer_i18n.options){var x=JSON.parse(classified_manager_viewer_i18n.options);void 0!==x[r]&&(y=x[r].filters)}f=y.mime_types,v=y.file_types,g=y.meta_type,b=y.file_limit,w=y.embed_limit,h=y.file_size,e.ajax({type:"POST",url:classified_manager_viewer_i18n.ajaxurl,data:{action:"classified_manager_mv_get_options",cm_mv_id:r,cm_mv_nonce:p},dataType:"json"}).done(function(e){}),s&&(wp.media.model.settings.post.id=s),a=wp.media.frames.file_frame=wp.media({title:e(this).data("uploader_title"),button:{text:e(this).data("uploader_button_text")},library:{post_mime_type:f},frame:"post",state:0!==b?"classified_manager-upload-media":"classified_manager-embed-media",multiple:!0}),a.states.remove("embed"),a.states.remove("gallery"),a.states.remove("gallery-edit"),a.states.remove("gallery-library"),0!==b&&a.states.add([new wp.media.controller.Library({id:"classified_manager-upload-media",title:"CLASSIFIED_MANAGER-MV-ITEM "+classified_manager_viewer_i18n.insert_media_title,toolbar:"main-insert",filterable:!1,searchable:!0,library:wp.media.query(a.options.library),multiple:a.options.multiple?"reset":!1,editable:!0,displayUserSettings:!1,displaySettings:!1,allowLocalEdits:!0})]),0!=w&&a.states.add([new wp.media.controller.Embed({id:"classified_manager-embed-media",toolbar:"main-embed",title:"CLASSIFIED_MANAGER-MV-ITEM "+classified_manager_viewer_i18n.embed_media_title})]),wp.media.frames.file_frame.uploader.options.uploader.params.classified_manager_media_manager=!0,wp.media.frames.file_frame.uploader.options.uploader.params.classified_manager_mv_id=r,wp.media.frames.file_frame.uploader.options.uploader.params.classified_manager_mv_mime_types=f,wp.media.frames.file_frame.uploader.options.uploader.params.classified_manager_mv_file_limit=b,wp.media.frames.file_frame.uploader.options.uploader.params.classified_manager_mv_file_size=h,a.on("close",function(){var m=a.state().get("selection"),l="",u=!0,v=!1,h=!1,y=0,x=0;if(void 0===m)l=a.state().props.get("url"),e(".clear-embeds").is(":checked")&&!l&&(l="clear"),u=!1;else{var E=new Array,A=new Array;m.each(function(e){e.id&&("video"!==e.attributes.type?((E.length<b||0>b)&&E.push(e.id),y++):((A.length<w||0>w)&&A.push(e.id),x++))}),v=Boolean(y>b),h=Boolean(x>b)}if(E||A||l){var I={action:"classified_manager_mv_manage_files",cm_mv_nonce:p,cm_mv_id:r,post_id:s,attachments:E,attach_embeds:A,embed_urls:l,meta_type:g,file_limit:b,mime_types:f};e.post(classified_manager_viewer_i18n.ajaxurl,I,function(a){var i=e("input[data-group-id="+r+"].upload_button"),t=e(i).data("upload-text"),s=Boolean(e("input[name="+r+"]").val()),m=Boolean(e("input[name="+_+"]").val()),n=output_embeds="";if(!a||"undefined"==typeof a.output)return void console.log("Error while assigning images: "+a);if(n=a.output,void 0===E&&n.attach_ids.length){attach_id=n.attach_ids,e(".media-attachments",c).append(n.files.html);var p=e("input[name="+r+"]").val();e("input[name="+r+"]").val(p?p+","+attach_id:attach_id),s=!0}else void 0!==E&&(s=0==E.length?!1:!0,e(".media-attachments",c).html(n.files.html),e("input[name="+r+"]").val(E),void 0!==n.embeds&&(l=n.embeds.url,output_embeds=n.embeds.html,n.embeds.list||d()));if(void 0!==A&&e("input[name="+o+"]").val(A),0!==w)if(l&&"clear"!==l){var f=e("input[name="+_+"]").val();f&&(f=e(".clear-embeds").is(":checked")?"":f.split(",")),0>w||w&&f.length<w?(f.length>0?(l=e("input[name="+_+"]").val()+", "+n.embeds.url,output_embeds=e(".media-embeds",c).html()+"<br/>"+n.embeds.html):output_embeds=n.embeds.html,e(".media-embeds",c).html(output_embeds),e("input[name="+_+"]").val(l),m=!0):alert(classified_manager_viewer_i18n.allowed_embeds_reached_text)}else e("input[name="+_+"]").val()&&"clear"!=l||(d(),m=!1);else l&&alert(classified_manager_viewer_i18n.embeds_not_allowed_text);v&&alert(classified_manager_viewer_i18n.files_limit_reached_text),h&&alert(classified_manager_viewer_i18n.embed_limit_reached_text),s||m?(e(".no-media",c).hide(),t=e(i).data("manage-text")):e(".no-media",c).show(),e(i).val(t),e(".classified-manager-media-viewer-spinner").html("")},"json").fail(function(e){console.log("Error while assigning images. Error: "+JSON.stringify(e))})}wp.media.model.settings.post.id=t,a="",e(i).remove(),n()}),a.on("open",function(){i=document.activeElement,e(".classified_manager-media-settings").remove(),e(".media-frame-menu").closest(".media-modal").addClass("classified-manager-media-viewer"),e('.media-frame-menu .media-menu-item:contains("CLASSIFIED_MANAGER-MV-ITEM '+classified_manager_viewer_i18n.insert_media_title+'")').addClass("classified_manager-mv-item"),e('.media-frame-menu .media-menu-item:contains("CLASSIFIED_MANAGER-MV-ITEM '+classified_manager_viewer_i18n.embed_media_title+'")').addClass("classified_manager-mv-item"),e(".media-frame-menu .media-menu-item:not(.classified_manager-mv-item)").remove();var t=a.state().get("selection");if(0!==b&&void 0!=e("input[name="+r+"]").val()){var s=e("input[name="+r+"]").val().trim(),m=e("input[name="+o+"]").val().trim();m&&(s=s+","+m),""!==s&&(s=s.split(","),s.forEach(function(e){attachment=wp.media.attachment(e),attachment.fetch(),t.add(attachment?[attachment]:[])}))}e(".classified-manager-media-viewer-spinner").html('<img src="'+classified_manager_viewer_i18n.spinner+'" alt="" width="16" height="16" />')}),a.open(),e(document).on("click",".media-menu-item",function(){e(".screen-reader-text").hide(),e(".media-frame-content select.attachment-filters").css({"max-width":"calc(75% - 12px)"}),e("a").css("text-decoration","none"),l()}),e(document).on("mousemove",".media-modal-content",function(e){}),e(".media-menu-item:first").trigger("click")}}),e("a.media-button").on("click",function(){wp.media.model.settings.post.id=t})});